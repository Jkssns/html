<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    
</body>
<script>
    class WPromise {
        static pending = 'pending';
        static fulfilled = 'fulfilled';
        static rejected = 'rejected';

        constructor(executor) {
            this.status = WPromise.pending; // 初始化状态为pending
            this.value = undefined; // 存储 this._resolve 即操作成功 返回的值
            this.reason = undefined; // 存储 this._reject 即操作失败 返回的值
            this.callbacks = []
            executor(this._resolve.bind(this), this._reject.bind(this));
        }

        _handler(callback) {
            const { onFulfilled, onRejected } = callback;

            if (this.status === WPromise.fulfilled && onFulfilled) {
                // 传入存储的值
                onFulfilled(this.value);
            }

            if (this.status === WPromise.rejected && onRejected) {
                // 传入存储的错误信息
                onRejected(this.reason)
            }
        }

        then(onFulfilled, onRejected) {
            // 这里可以理解为在注册事件
            // 也就是将需要执行的回调函数存储起来
            this.callbacks.push({
                onFulfilled,
                onRejected,
            })
        }

        _resolve(value) {
            this.value = value;
            this.status = WPromise.fulfilled; // 将状态设置为成功

            this.callbacks.forEach((cb) => this._handler(cb));
        }
        
        _reject(reason) {
            this.reason = reason;
            this.status = WPromise.rejected; // 将状态设置为失败

            this.callbacks.forEach((cb) => this._handler(cb));
        }
    }

    function aaa() {
        return new WPromise((rel, rej) => {
            setTimeout(() => Math.random() > 0.5 ? rel(true) : rej(false), 0)
        })
    }

    // aaa().then(res => {
    //     console.log("res::: ", res);
    // }, err => {
    //     console.log("err::: ", err);
    // })
</script>
</html>